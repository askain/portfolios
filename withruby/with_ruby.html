<html>
<head>
</head>
<body>
  <h1>Ruby on rails 와의 추억</h1>
  <p>아래는 루비 온 레일즈를 반년넘게 사용하면서 있었던 추억을 시간 순서대로 기록한 내용입니다.</p>
  <p>저의 개인적인 의견이며 대부분의 루비 온 레일즈 사용자들과 의견이 다를 수 있습니다.</p>
  <p>제가 한글이 미숙하여 오타 및 띄어쓰기가 보기 불편하실 수 있습니다.</p>
  <ul>
    <li>추억 1. AWS 서버가 하루에 세번씩 시간이 지나면서 죽는 일이 있었다. 원인은 shoryuken 이 메모리를 계속 확보하다가 100%가 되면 서버 정지. shoryuken 버전업하여 해결</li><br>
    <li>추억 2. 여전히 메모리 릭이 있어서 aws와 shoryuken 버전을 더 업하여 해결. 그런데!!!!!!!<br>gemfile을 수정하여 aws 2.x 에서 3.x 버전으로 업그레이드하니 rails버전을 맘대로 업데이트 해버림. 더 상단에 rails 버전이 선언되어있어도 소용 없음.<br>
<br>
기존<br>
gem ‘rails’, ‘5.0.1’,<br>
gem ‘aws-client’, ‘~> 2’,<br>
<br>
신규<br>
gem ‘rails’, ‘5.0.1’, # aws-client 3.x으로 업데이트 하니 rails 가 5.0.6으로 자동 업데이트 됨<br>
gem ‘aws-client’, ‘~> 3’,<br>
<br>
배포하니 rails 5.0.6이 깔려 있음. (처음배포때는 5.1.x 버전이 깔려버렸는데 버전이 자세히 기억이 안남)<br>
게다가 gem list를 보니 Activemodel 등이 버전이 두가지씩 깔려버렸음.<br> 그래서 메뉴얼하게 구버전을 하나하나 삭제해줌.</li>
    <li>추억 2-1. gem list 실행해서 activemodel 등에 두가지 버전이 깔려버렸는데 구 버전들 삭제하고 배포 후 AWS_REGION설정이 안되었다고 에러가 남. AWS_REGION 설정을 일단은 해야 하는거 같으면서도 나중에 보니 안해도 됨???? 나도 무슨 일이 일어난 것인지 모르겟다.</li><br>
    <li>추억 3. gem 삭제로 인한 gem update 후에 몇가지 minor gem들이 업데이트 됨. 그런 이유로 memory leak이 미친듯이 늘어서 원인을 찾는 도중에 몇번 더 업데이트로 인해 memory leak 이 없어짐. 무슨 gem이 원흉인지 모르겠다.</li><br>
    <li>추억 4. gem list 정리를 했는데 memory 사용률이 매우 양호해짐. 그중에 쓰지않는 twilio gem을 삭제해서 그런게 아닐까 추측 중</li><br>
    <li>추억 5. uptime 오래된 서버는 재기동 시켜줘야 함. 메모리 릭. 오래된 서버를 계속 재기동 시켜줘서 시스템을 유지하고 있음</li><br>
    <li>추억 6. octopus gem이 redis gem과 호환이 안되어서 replication 에 select 쿼리 날릴 시 옛날 캐쉬를 참조. 그래서 octopus를 삭제 할 밖에 없었음<br>나중에 makara gem을 대신 써서 해결</li><br>
    <li>추억 7. ActiveResult 가 캐쉬를 쓰고/안쓰고를 manual하게 조정할 수 없음. 쿼리 가져온 결과중에서 결과를 다시 뽑아내면 되는데 DB에 쿼리를 또 날림. 또 반대로 원치 않는데 캐시를 자꾸 쓰는 경우가 있음. 캐시쓰는걸 못 쓰게 할려고 다음처럼 명령을 내림 여기서 another_table은 테이블 이름임.<br>
Amodel.another_table = true 또는 Amodel.another_table(true)</li><br>
    <li>추억 8. 서버 CPU가 57%로 고정 되면서 먹통이 됨. ssh 접속도 안되고. 재기동 후 정상화 됨. 원인 불명. 그 와중에 쌍둥이 서버는 정상. 일단 인스턴스 재기동하여 해결.</li><br>
    <li>추억 9. 이건 사람이 문제이긴 한데, 갑자기 staging DB에 모든 데이터가 없어져버렸음. 누군가 rake db:reset을 실행한 것이 아닌가 예상을 했지만 범인을 찾을 수 없었음. 가장 심각한 문제는 이걸 예방할 방법도 없음. 나중에 범인 찾음. 동료가 범인이었다.</li><br>
    <li>추억 10. DB dead lock 이 생겨서 에러가 자꾸 발생. 이유 불명. 확인해보면 락은 안 걸려있음. 쓸데없는 transaction 명령을 삭제하여 해결</li><br>
    <li>추억 11. form_for(변수)를 사용할때  ‘admin_room_archive_path’를 찾아야 하는데 undefined method `room_archive_path' 에러가 발생.(파일을 수정하고 실행하면 잘나오고 다시 실행하면 에러난다.) 몇달 전부터 문제없이 잘 사용했는데 어느 날 부터 에러발생.<br>
이유는 rails 버그 routes.rb에서 resource를 이용해서 라우팅 한경우 어째서인지 as 명을 라우팅이 누락하는 경우가 있다. 명시적으로 라우팅을 해줘야함. 유명한 버그인듯.<br>
[:admin, xxxxx] 네임스페이스를 추가해서 해결했다고 생각했는데 나중에 또 에러남 있어도 문제 없어도 문제 ㅋㅋㅋ. 이딴게 무슨 프레임워크라고</li><br>
    <li>추억 12. 다음 코드로 쿼리를 실행하면 user_id가 있어도 where user_id = ? 가 생략됨.
if where.key?(:user_id)<br>
  ret.where(user_id: where[:user_id])<br>
end<br>
<br>
해결법은 ret = ret.where(user_id: where[:user_id])<br>
이런 일이야 뭐... 있을 수 있다고 생각한다.</li><br>
    <li>추억 13. 이상하게 unix timestamp 를 찍으면 utc가 아닌 asia/seoul을 숫자로 변환. 결국 실제 시간보다 9시간 후의 시간이 됨. 참고로 php laravel, nodejs express에서는 정상적으로 utc 를 숫자로 표시함.<br>
서버(Asia/Seoul)                ->                DB(기본설정)            ->             서버(Asia/Seoul)<br>
                                                           +9시간으로 저장             .to_i 시 +9시간 더함 = 총 18시간<br>
별다른 설정이 없는한 rail는 db를 utc로 생각하고 로컬/서버 시간이 utc가 아닌경우 db insert/update 할때 시간을 가감하여 실행함.[확인함] 로컬/서버가 utc면 가감하지 않음. [확인함] 그리고 가져올때도 마찬가지라고 생각했으나 rails 가 로컬/서버의 timezone에 관계 없이 +9시간 한 timestamp를 반환함.
같은 컴퓨터에서 실행한 다른 프레임워크에서는 정상적으로 동작하는 걸 보니 이건 완벽하게 버그라고 할 수 있음<br>
이라고 생각했는데 나중에 여기에 대한 설정을 찾았음. 단 실험해 보진 않음. ActiveSupport.to_time_preserves_timezone = true<br>
서버 설정도 UTC로 해놓으므로서 해결<br>
</li><br>
    <li>추억 14. 전역변수로 등록해 놓은 @@variable 에 인스턴스를 클래스 인스턴스가가 생성될때 생성되게 해놨는데 nil 이라고 에러남. GC가 없애버렸나???? 황당... 그래서 nil인지 체크해서 nil이면 새로만들도록 함.</li><br>
    <li>추억 15. thread 수를 두배 늘리는거보다 Procfile에서 worker를 두배로 늘리는 것이 기동 직후 차지하는 리소스가 더 적다. 후자가 쓰레드 수는 같으면서도 더 많은 worker 수를 가지는데 왜일까?</li><br>
    <li>추억 16. bundle update로 필요한 sub-gem이 안깔려서 에러가 난적이 있음. 이유는 모르지만 다시 배포하여 해결.</li><br>
    <li>추억 17. puma가 먹통이 되고 kill script로 중지가 되지 않을때가 있다… 수동으로 worker까지 모두 종류해준후 기동하면 제대로 동작함</li><br>
    <li>추억 18. 어느 순간 부터 JSON.parse(params[:aaaa]) 가 에러를 내기 시작함. params로 가져오는 인스턴트들이 ActiveParameter인데 JSON.parse로 변환이 안됨. bundle update로 자동으로 업데이트된 minor gem 때문인걸로 잠정 결론. Rails 유지보수하는 새끼들은 이용자들 엿먹이는 재주가 있나보다…</li><br>
    <li>추억 19. makara 설정할때 max pool count는 각 master, slave 설정에 끼워넣어야 적용됨. 즉 total max pool count 는 적용이 안됨. 그리고 master에 넣은 ip가 slave에 있더라도 별개의 connection을 생성함. 예를 들어, master ip1 pool 50개, slave ip1 pool 50개 이런식으로 설정하면  max pool 100개가 됨. 그리고 master의 ip를 slave에 넣더라도 connection을 공유하지 않음.</li><br>
  </ul>
</body>
</html>
